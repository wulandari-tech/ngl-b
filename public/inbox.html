<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inbox Saya - NGL Clone</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            color: #333;
            line-height: 1.6;
            background: linear-gradient(135deg, #f8b195, #f67280, #c06c84);
            background-attachment: fixed;
            padding: 20px 0;
        }

        .container {
            max-width: 700px;
            margin: 20px auto;
            background: rgba(255, 255, 255, 0.98);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-top: 0;
            margin-bottom: 25px;
        }

        .ngl-link-section p {
            text-align: center;
            margin-bottom: 5px;
            color: #555;
        }

        #ngl-link {
            font-weight: bold;
            word-break: break-all;
            color: #c06c84;
            text-decoration: none;
        }
         #ngl-link:hover {
             text-decoration: underline;
         }

        .copy-action {
            text-align: center;
            margin-bottom: 25px;
        }

        #copy-link-button {
            background-color: #f67280;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s ease;
        }
         #copy-link-button i {
             margin-right: 5px;
         }

        #copy-link-button:hover {
            background-color: #c06c84;
        }

        #copy-status {
            display: inline-block;
            margin-left: 10px;
            font-size: 0.9em;
            font-weight: bold;
        }
        #copy-status:empty { display: none; }
        #copy-status.success { color: #28a745; }
        #copy-status.error { color: #dc3545; }


        .message-list {
            list-style: none;
            padding: 0;
            margin-top: 25px;
        }
         .message-list li#loading-placeholder,
         .message-list li#no-messages-placeholder {
            text-align: center;
            color: #777;
            padding: 20px;
            font-style: italic;
         }

        .message-item {
            background: #fff;
            border: 1px solid #eee;
            padding: 15px 20px;
            margin-bottom: 15px;
            border-radius: 10px;
            border-left: 5px solid #f8b195;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .message-item p {
            margin: 0 0 8px 0;
            word-wrap: break-word;
            font-size: 1.05em;
            color: #444;
        }

        .message-time {
            font-size: 0.8em;
            color: #888;
            display: block;
        }

        #logout-button {
            background-color: #6c757d;
            color: white;
            padding: 10px 18px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.95em;
            transition: background-color 0.2s ease;
            display: block;
            margin: 30px auto 0 auto;
            min-width: 120px;
            text-align: center;
        }
        #logout-button i {
            margin-right: 6px;
        }

        #logout-button:hover {
            background-color: #5a6268;
        }

         @media (max-width: 600px) {
             .container { padding: 20px; }
             h1 { font-size: 1.6em;}
         }

    </style>
</head>
<body>
    <div class="container">
        <h1>Pesan Anonim Saya</h1>

        <div class="ngl-link-section">
             <p>Bagikan Link NGL Anda:</p>
             <p><a href="#" id="ngl-link" target="_blank">Memuat link...</a></p>
        </div>

        <div class="copy-action">
             <button id="copy-link-button"><i class="fas fa-copy"></i> Salin Link</button>
             <span id="copy-status"></span>
        </div>


        <ul id="message-list" class="message-list">
             <li id="loading-placeholder">Memuat pesan...</li>
        </ul>

        <button id="logout-button"><i class="fas fa-right-from-bracket"></i> Logout</button>
    </div>

    <script>
        const messageList = document.getElementById('message-list');
        const nglLinkEl = document.getElementById('ngl-link');
        const copyButton = document.getElementById('copy-link-button');
        const copyStatus = document.getElementById('copy-status');
        const logoutButton = document.getElementById('logout-button');
        const loadingPlaceholder = document.getElementById('loading-placeholder');

        function renderMessage(msg) {
            const item = document.createElement('li');
            item.className = 'message-item';
            item.dataset.id = msg._id;

            const content = document.createElement('p');
            content.textContent = msg.content;

            const time = document.createElement('span');
            time.className = 'message-time';
            time.textContent = new Date(msg.createdAt).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' });

            item.appendChild(content);
            item.appendChild(time);
            return item;
        }

        function displayNoMessages() {
             messageList.innerHTML = '<li id="no-messages-placeholder">Belum ada pesan. Bagikan link Anda!</li>';
        }

        async function fetchMessages() {
            try {
                const response = await fetch('/api/my-messages');
                if (!response.ok) {
                     if(response.status === 401) {
                         window.location.href = '/';
                         return;
                     }
                    throw new Error('Gagal memuat pesan');
                }
                const messages = await response.json();

                if (loadingPlaceholder) loadingPlaceholder.remove();
                messageList.innerHTML = '';

                if (messages.length === 0) {
                     displayNoMessages();
                } else {
                    messages.forEach(msg => {
                        messageList.appendChild(renderMessage(msg));
                    });
                }
            } catch (error) {
                 if (loadingPlaceholder) loadingPlaceholder.remove();
                 messageList.innerHTML = '<li id="no-messages-placeholder">Gagal memuat pesan. Coba lagi nanti.</li>';
            }
        }

        async function fetchUserInfo() {
             try {
                 const response = await fetch('/api/me');
                 if (!response.ok) {
                     if(response.status === 401) {
                         window.location.href = '/';
                         return;
                     }
                     throw new Error('Gagal memuat info user');
                 }
                 const userData = await response.json();
                 const currentUser = userData.username;
                 const fullLink = `${window.location.origin}/ngl/${currentUser}`;
                 nglLinkEl.textContent = fullLink;
                 nglLinkEl.href = fullLink;

             } catch (error) {
                 nglLinkEl.textContent = 'Gagal memuat link';
                 nglLinkEl.href = '#';
             }
        }

         copyButton.addEventListener('click', () => {
             const linkToCopy = nglLinkEl.href;
             if (linkToCopy && linkToCopy !== '#') {
                 navigator.clipboard.writeText(linkToCopy).then(() => {
                     copyStatus.textContent = 'Link disalin!';
                     copyStatus.className = 'success';
                     setTimeout(() => { copyStatus.textContent = ''; copyStatus.className = ''; }, 2500);
                 }).catch(err => {
                     copyStatus.textContent = 'Gagal menyalin';
                     copyStatus.className = 'error';
                     setTimeout(() => { copyStatus.textContent = ''; copyStatus.className = ''; }, 3000);
                 });
             } else {
                 copyStatus.textContent = 'Link belum siap';
                 copyStatus.className = 'error';
                 setTimeout(() => { copyStatus.textContent = ''; copyStatus.className = ''; }, 3000);
             }
         });

         logoutButton.addEventListener('click', async () => {
            logoutButton.disabled = true;
            logoutButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logout...';
             try {
                 const response = await fetch('/api/logout', { method: 'POST' });
                 if (response.ok) {
                     window.location.href = '/';
                 } else {
                     alert('Logout gagal. Coba lagi.');
                     logoutButton.disabled = false;
                     logoutButton.innerHTML = '<i class="fas fa-right-from-bracket"></i> Logout';
                 }
             } catch (error) {
                 alert('Terjadi kesalahan saat logout.');
                 logoutButton.disabled = false;
                 logoutButton.innerHTML = '<i class="fas fa-right-from-bracket"></i> Logout';
             }
         });


        const socket = io();

        socket.on('connect', () => {
            console.log('Terhubung ke WebSocket server');
        });

        socket.on('disconnect', () => {
            console.log('Terputus dari WebSocket server');
        });

        socket.on('connect_error', (err) => {
            console.error('Kesalahan koneksi WebSocket:', err.message);
             if (err.message === 'Authentication required') {
                setTimeout(() => { window.location.href = '/'; }, 2000);
             }
        });

        socket.on('new_message', (newMessage) => {
            const messageItem = renderMessage(newMessage);
            const noMessagesLi = document.getElementById('no-messages-placeholder');
             if (noMessagesLi) {
                 messageList.innerHTML = '';
             }
            messageList.insertBefore(messageItem, messageList.firstChild);
        });

        fetchUserInfo();
        fetchMessages();

    </script>
</body>
</html>